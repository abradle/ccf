/*! 
gridvar - v1.0.0 - 2014-01-02
Copyright (c) 2014, Novartis Institutes for Biomedical Research, Inc.
with a principal place of business at:

250 Massachusetts Avenue
Cambridge, MA 02139 USA
http://opensource.nibr.com

All rights reserved.

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

* Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.

* Redistributions in binary form must reproduce the above copyright notice, this
  list of conditions and the following disclaimer in the documentation and/or
  other materials provided with the distribution.

* Neither the name of the Novartis Institutes for BioMedical Research, Inc. nor the names of its
  contributors may be used to endorse or promote products derived from
  this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.*/ 

!function(a){"use strict";a.widget("nibr.gridVar",{options:{cellWidth:12,cellHeight:12,transitionDuration:1500,legendStyles:{"stroke-width":1,stroke:"#aaaaaa",swatchDimension:10},styles:{glyph:{fill:"none",stroke:"#888888","stroke-width":2,"stroke-opacity":1}},attrs:{glyph:{opacity:.6,cssClass:"glyph"}},histogramMapping:{label:"Histogram",scale:1,totalTicks:2},multipleLegendLines:{include:!1}},_create:function(){var a=this,b=a._calculateLabelSize(a.options.columnOrder,a.options.columnKeysToLabel,15);a.yAxisMapping=a._updateYAxisMapping(a.options.rowOrder),a.xAxisMapping=a._updateXAxisMapping(a.options.columnOrder),a.textScaleFactor=15,a.yAxisBuffer=5,a.yAxisWidth=a.yAxisBuffer+a._calculateLabelSize(a.options.rowOrder,a.options.rowKeysToLabel,a.yAxisBuffer),a.margin={top:10,right:a.yAxisWidth,bottom:_.max([b,60]),left:0},a.renderers=a._assembleRenderers(["dotRenderer","minusRenderer","plusRenderer","circleRenderer","xRenderer","rectRenderer"]),a.displayStyles=a._calculateDisplayStyles(a.options.dataDisplayMapping),a.render()},_calculateLabelSize:function(a,b,c){var d=this,e=0;return _(a).each(function(a){var c=!_.isUndefined(b)&&_.has(b,a)?b[a]:a,f=d._calculateTextSize(c);f>e&&(e=f)}),e+=c},_assembleRenderers:function(a){var b=this,c={};return _(a).each(function(a){c[a]=b["_"+a]}),c},_getDefaultOptions:function(a){var b=this;return"styles"===a?b.options.styles.glyph:{opacity:b.options.attrs.glyph.opacity,"class":b._createCssClass(b.options.attrs.glyph.cssClass)}},_getRenderOpts:function(a,b){var c=this,d={},e={},f=c._getDefaultOptions(b);return _.extend(d,f,a),_.each(d,function(a,b){var c={};c=_.isFunction(a)?function(b){var c=d3.select(this),d=c.attr("width"),e=c.attr("height");return a.call(this,b,d,e)}:a,e[b]=c}),e},_normalizeRenderers:function(a){var b=this,c={};if(!_.isFunction(a)&&!_.isObject(a)){if("#"===a.substring(0,1))return c.styles={"stroke-width":0,opacity:1,fill:a,stroke:b.options.styles.stroke},c.attrs={d:b.renderers.rectRenderer},{renderOpts:c,renderType:"background"};if(_.has(b.renderers,a))return c.styles={},c.attrs={d:b.renderers[a]},{renderOpts:c,renderType:"glyph"};throw b.name+"Error: I could not find the built-in renderer "+a+" .  Avaliable renderers are: "+_.keys(b.renderers)+" if you wish to use a background color it must start with a #"}if(_.isFunction(a))return c.styles={},c.attrs={d:a},{renderOpts:c,renderType:"glyph"};if(_.has(a,"attrs")||_.has(a,"styles"))return _.has(a,"attrs")&&_.has(a.attrs,"d")&&_.has(b.renderers,a.attrs.d)&&(a.attrs.d=b.renderers[a.attrs.d]),{renderOpts:_.extend({styles:{},attrs:{}},a),renderType:"glyph"};throw b.name+" the render object is of the wrong format; you should have at least a attrs or styles object at a minimum"},_calculateDisplayStyles:function(a){var b=this,c={};return _(a).each(function(a){var d={};_(a.mappings).each(function(a,c){var e=b._normalizeRenderers(a),f=b._getRenderOpts(e.renderOpts.styles,"styles"),g=b._getRenderOpts(e.renderOpts.attrs,"attrs");d[c]={renderType:e.renderType,styles:f,attrs:g}}),_(a).has("labelMapping")||(a.labelMapping=b._createLabelMapping(a.mappings)),d.labels=a.labelMapping,c[a.dataType]=d}),c},_createLabelMapping:function(a){var b={};return _(a).each(function(a,c){b[c]=c}),b},_getHeight:function(a){var b=this;return void 0===a&&(a=b.options.rowOrder.length),a*b.options.cellHeight},_getWidth:function(a){var b=this;return void 0===a&&(a=b.options.columnOrder.length),a*b.options.cellWidth},_getWidgetBaseClass:function(){var b,c=this,d=a.ui.version.split(".");return b=d[0]>1?c.widgetFullName:d[1]>8?c.widgetFullName:c.widgetBaseClass},_updateXAxisMapping:function(a){var b=this,c=b._getWidth(a.length);return d3.scale.ordinal().domain(a).rangeRoundBands([0,c],0)},_updateYAxisMapping:function(a){var b=this,c=b._getHeight(a.length);return d3.scale.ordinal().domain(a).rangeRoundBands([0,c],0)},_setOption:function(b,c){var d=this;a.Widget.prototype._setOption.apply(this,arguments),"columnOrder"===b?d._updateColumnOrdering(c):"rowOrder"===b?d._updateRowOrdering(c):"histogramMapping"===b&&d._updateHistogram()},_updateColumnOrdering:function(a){var b,c=this,d=c.yAxisMapping,e=c.options.columnKeysToLabel||{},f=d3.select(c._getHeatmapSelector()).transition().duration(c.options.transitionDuration),g=c.options.dataMapping.dataIndex;c.xAxisMapping=c._updateXAxisMapping(a),f.selectAll("."+c._createCssClass("cell")).attr("transform",function(a){var b=[c.xAxisMapping(a[g.columnKey]),d(a[g.rowKey])];return"translate("+b.join(",")+")"}),b=d3.svg.axis().scale(c.xAxisMapping).ticks(c.xAxisMapping.length).orient("bottom"),f.select(".x."+c._createCssClass("axis")).delay(function(a,b){return 4*b}).call(b),f.select(".x."+c._createCssClass("axis")).selectAll("text").attr("class",c._getWidgetBaseClass()).style("text-anchor","end").text(function(a){return e[a]||a})},_updateRowOrdering:function(a){var b,c=this,d=c.xAxisMapping,e=d3.select(c._getHeatmapSelector()).transition().duration(c.options.transitionDuration),f=d3.select("."+c._createCssClass("grid-label-rows")),g=c.options.rowKeysToLabel||{},h=c.options.dataMapping.dataIndex;c.yAxisMapping=c._updateYAxisMapping(a),e.selectAll("."+c._createCssClass("cell")).attr("transform",function(a){var b=[d(a[h.columnKey]),c.yAxisMapping(a[h.rowKey])];return"translate("+b.join(",")+")"}),b=d3.svg.axis().scale(c.yAxisMapping).ticks(c.yAxisMapping.length).orient("right"),f.select(".y."+c._createCssClass("axis")).call(b).selectAll("text").text(function(a){return g[a]||a}).style("text-anchor","end").attr("x",c.yAxisWidth-c.yAxisBuffer).attr("opacity",0).transition().attr("opacity",1).duration(c.options.transitionDuration).delay(function(a,b){return 4*b}),c._hasHistogram()&&(d3.selectAll("rect."+c._createCssClass("bar")).data(c.options.rowOrder),c._updateHistogram())},destroy:function(){var b=this;b.remove(),a.Widget.prototype.destroy.call(this)},_calculateTextSize:function(a){return 7*a.length},_calculateLegendPositions:function(a,b){var c,d=this,e=20,f=[],g=d.options.multipleLegendLines,h=0;return g.include&&!_.isUndefined(g.labels)&&(c=_.clone(g.labels),h=5*_(c).max(function(a){return a.length}).length),_(b).each(function(b){f.push(h),h+=6*b.length+a+e}),f},_createLegend:function(a){var b,c,d,e=this,f=13,g=e.options.legendStyles.swatchDimension,h=2*g+5,i=5,j=e.options.multipleLegendLines;_.isUndefined(a)&&(a=e.displayStyles),j.include?(d=_.clone(j.labels),c=5,_.isUndefined(d)&&(d=[],_(a).each(function(){d.push("")})),f=5,h*=_.size(a),i=5+_(d).max(function(a){return a.length}).length,b=d3.select(e._getLegendSelector()).append("svg").attr("width","100%").attr("height",h).append("g"),_(a).each(function(j){var k,l=d.shift();k=b.append("g").attr("class",e._createCssClass("renderings")).attr("transform","translate("+i+","+c+")"),e._renderLegends(j,k,f,g,j.labels),k=d3.select(e._getLegendSelector()).select("g").insert("text","."+e._createCssClass("renderings")).attr("transform","translate(0,"+(c+10)+")").text(l).attr("class",e._createCssClass("legend-category-label")),c+=h/_.size(a)})):(b=d3.select(e._getLegendSelector()).append("svg").attr("width","100%").attr("height",h).append("g"),_(a).each(function(a){var c=b.append("g").attr("class",e._createCssClass("renderings")).attr("transform","translate("+i+",0)");e._renderLegends(a,c,f,g,a.labels),i+=c[0][0].getBBox().width+10}))},_renderLegends:function(a,b,c,d,e){var f=this,g=.5*d,h=_.values(e),i=_.keys(e),j=[],k=f.options.multipleLegendLines;!_.isUndefined(k)&&k.include&&(g=0,c=1.5*c),j=f._calculateLegendPositions(d,h),b.selectAll(f._createCssClass("legend-glyph")).data(i).enter().append("path").attr("width",d).attr("height",d).call(f._applyStylesGroup,a,i,f).call(f._applyAttrsGroup,a,i,f).attr("class",f._createCssClass("legend-glyph")).attr("transform",function(a,b){var c=[j[b],g];return"translate("+c.join(",")+")"}),b.selectAll(f._createCssClass("legend-glyph")).data(i).enter().append("rect").attr("fill","none").attr("stroke",f.options.legendStyles.stroke).attr("stroke-width",function(b){return"background"===a[b].renderType?2:0}).attr("width",d+f.options.legendStyles["stroke-width"]).attr("height",d+f.options.legendStyles["stroke-width"]).attr("transform",function(a,b){var c=[j[b]-f.options.legendStyles["stroke-width"],g-f.options.legendStyles["stroke-width"]];return"translate("+c.join(",")+")"}),b.selectAll(f._createCssClass("legend-label")).data(h).enter().append("svg:text").text(function(a){return a}).attr("class",f._createCssClass("legend-label")).attr("transform",function(a,b){var e=[j[b]+d+5,c];return"translate("+e.join(",")+")"})},_minusRenderer:function(a,b,c){var d=_([b,c]).min(),e=.5*d,f=e*(1/3);return"M"+f+","+e+"H"+(d-f)},_plusRenderer:function(a,b){var c=.5*b,d=c*(1/3);return"M"+c+","+d+"V"+(b-d)+"M"+d+","+c+"H"+(b-d)},_dotRenderer:function(a,b,c){var d=_([b,c]).min(),e=2,f=.5*d;return"M "+f+","+f+"m -1, 0a 1,1 0 1,0  "+e+",0a 1,1 0 1,0 -"+e+",0"},_circleRenderer:function(a,b,c){var d=.5*_([b,c]).min(),e=d*(1/3),f=2*e;return"M "+d+","+d+"m -"+e+", 0a "+e+","+e+" 0 1,0  "+f+",0a "+e+","+e+" 0 1,0 -"+f+",0"},_rectRenderer:function(a,b,c){return"M0,0L"+(b-1)+",0L"+(b-1)+","+(c-1)+"L0,"+(c-1)+"L0,0"},_xRenderer:function(a,b,c){var d=.5*(_([b,c]).min()-1),e=.5*d,f=[d-e,d-e].join(","),g=[d-e,d+e].join(","),h=[d+e,d-e].join(","),i=[d+e,d+e].join(",");return"M"+f+"L"+i+"M"+g+"L"+h},_createToolTip:function(b,c){a(b).qtip({position:{my:"bottom left",target:"mouse",viewport:a(window),adjust:{x:5,y:-5}},hide:{fixed:!0,effect:function(){a(this).animate({opacity:0},{duration:0})}},show:{effect:function(){a(this).show().css({opacity:0}).animate({opacity:1},{duration:0})}},style:"ui-tooltip-shadow"}),c&&a(b).qtip("hide").qtip("disable")},_drawHistogram:function(a){var b,c,d,e,f=this,g=a.data,h=f.yAxisMapping,i={top:f.margin.top,right:60,bottom:f.margin.bottom,left:10},j=120-i.left-i.right,k=f._getHeight(),l=f._getHistogramScale(),m=f._getTickValues();b=d3.scale.linear().domain([l,0]).range([0,j]),e=d3.svg.axis().scale(b).tickValues(m).orient("bottom").tickPadding(8),d=d3.svg.axis().scale(h).orient("right").tickSize(0).tickPadding(8),c=d3.select(f._getHistogramSelector()).append("svg").attr("width",j+i.left+i.right).attr("height",k+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")"),c.selectAll(f._createCssClass("bar")).data(f.options.rowOrder).enter().append("rect").attr("class",f._createCssClass("bar")).attr("y",function(a){return h(a)}).attr("height",h.rangeBand()).attr("x",j).attr("width",0).transition().delay(function(a,b){return 4*b}).duration(f.options.transitionDuration).attr("x",function(a){return b(g[a])}).attr("width",function(a){return j-b(g[a])}),c.append("g").attr("class",f._createCssClass("xaxis")).attr("transform","translate(0,"+h.rangeExtent()[1]+")").call(e),c.select("."+f._createCssClass("xaxis")).selectAll("text").attr("transform","translate(-18,15)rotate(-90)").text(function(a){return(100*a).toFixed(0)+"%"}).style("text-anchor","end"),c.append("g").attr("class",f._createCssClass("yaxis")).attr("transform","translate("+j+",0)").call(d).selectAll("text").text(function(a){return(100*g[a]).toFixed(1)+"%"}),_(a).has("label")&&c.append("text").attr("class",f._createCssClass("x label")).attr("y",k+i.top+i.bottom-20).attr("x",j+i.left+i.right-30).text(a.label)},_getTickValues:function(){var a,b=this,c=b._getHistogramScale(),d=b.options.histogramMapping.totalTicks,e=[];if(1===d)e.push(c);else if(d>0)for(a=0;d>a;a+=1)e.push(c*(a/(d-1)));return e},_getHistogramScale:function(){var a=this,b=a.options.histogramMapping.scale;return"auto"===b&&(b=_(a.options.histogramMapping.data).max(function(a){return a})),b},_updateHistogram:function(){var a,b,c=this,d=c.options.histogramMapping.data,e={top:c.margin.top,right:60,bottom:c.margin.bottom,left:10},f=120-e.left-e.right,g=d3.svg.axis().scale(c.yAxisMapping).orient("right").tickSize(0).tickPadding(8),h=c._getHistogramScale(),i=c._getTickValues();a=d3.scale.linear().domain([h,0]).range([0,f]),b=d3.svg.axis().scale(a).tickValues(i).orient("bottom").tickPadding(8),d3.selectAll("rect."+c._createCssClass("bar")).transition().duration(c.options.transitionDuration).attr("y",function(a){return c.yAxisMapping(a)}).attr("x",function(b){return a(d[b])}).attr("width",function(b){return f-a(d[b])}).delay(function(a,b){return 4*b}),d3.select("."+c._createCssClass("yaxis")).transition().duration(c.options.transitionDuration).call(g).selectAll("text").text(function(a){return(100*d[a]).toFixed(1)+"%"}).delay(function(a,b){return 4*b}),d3.select("."+c._createCssClass("xaxis")).call(b).selectAll("text").attr("transform","translate(-18,15)rotate(-90)").text(function(a){return(100*a).toFixed(0)+"%"}).style("text-anchor","end")},_renderCells:function(a,b){var c=this,d=c.options.dataMapping.dataIndex,e=c.displayStyles,f=c.options.dataDisplayMapping;b.each(function(a){var b=this;_(f).each(function(f){var g=f.dataType,h=e[g],i=_(h).keys(),j=[];j=_(a[d[g]]).filter(function(a){return _(i).contains(a)}),d3.select(b).selectAll().data(j).enter().append("path").attr("width",c.options.cellWidth).attr("height",c.options.cellHeight).call(c._applyStyles,h,j).call(c._applyAttrs,h,j)})})},_attrWrapper:function(a){return function(b){var c=this,d=a;_.each(d[b].attrs,function(a,b){d3.select(c).attr(b,a)})}},_styleWrapper:function(a){return function(b){var c=this,d=a;_.each(d[b].styles,function(a,b){d3.select(c).style(b,a)})}},_applyAttrsGroup:function(a,b,c,d){_.each(c,function(){a.each(d._attrWrapper(b))})},_applyStylesGroup:function(a,b,c,d){a.each(d._styleWrapper(b))},_applyStyles:function(a,b,c){if(!_.isUndefined(b[c])){var d=b[c].styles;_.each(d,function(b,c){a.style(c,b)})}},_applyAttrs:function(a,b,c){if(!_.isUndefined(b[c])){var d=b[c].attrs;_.each(d,function(b,c){a.attr(c,b)})}},_createCssClass:function(a){var b=this;return[b._getWidgetBaseClass(),"-",a].join("")},_createCells:function(a){var b=this,c=b.xAxisMapping,d=b.yAxisMapping,e=b.options.dataMapping.data,f=b.options.dataMapping.dataIndex,g=a.selectAll("."+b._createCssClass("cell")).data(e).enter().append("g").attr("class",b._createCssClass("cell")).attr("transform",function(a){var b=[c(a[f.columnKey]),d(a[f.rowKey])];return"translate("+b.join(",")+")"}).attr("title",function(a){var c="";return b.options.cellTip&&(c=b.options.cellTip(a)),c}).on("click",function(a){b._trigger("cellClicked",void 0,[a])});return g},_getHeatmapSelector:function(){var b=this;return a(b.element.children()[4]).children()[0]},_getGridLabelsSelector:function(){var a=this;return a.element.children()[3]},_getHistogramSelector:function(){var a=this;return a.element.children()[2]},_getLegendSelector:function(){var a=this;return a.element.children()[1]},_getExportSelector:function(){var a=this;return a.element.children()[0]},render:function(){var b,c=this,d=c.options.rowKeysToLabel||{},e=c.options.columnKeysToLabel||{},f=['<div class="'+c._createCssClass("export")+'"></div>','<div class="'+c._createCssClass("legend")+'"></div>','<div class="'+[c._createCssClass("histogram"),c._createCssClass("left")].join(" ")+'"></div>','<div class="'+[c._createCssClass("grid-labels"),c._createCssClass("left")].join(" ")+'"></div>','<div class="'+c._createCssClass("container")+'">','<div class="'+c._createCssClass("heatmap")+'"></div>',"</div>"],g=c.margin,h=c._getWidth(),i=c._getHeight(),j=c.xAxisMapping,k=c.yAxisMapping,l=d3.svg.axis().scale(j).ticks(j.length).orient("bottom"),m=d3.svg.axis().scale(k).ticks(k.length).orient("right"),n=c.yAxisWidth,o=g.bottom;c.element.append(f.join(""));var p=d3.select(c._getHeatmapSelector()).append("svg").attr("class",c._createCssClass("heatmapCanvas")).attr("width",h).attr("height",i+o).append("g").attr("transform","translate("+g.left+","+g.top+")"),q=p.append("g");q.append("g").attr("class","x "+c._createCssClass("axis")).attr("transform","translate(0,"+i+")").call(l);var r=d3.select(c._getGridLabelsSelector()).append("svg").attr("class",c._createCssClass("gridLabels-canvas")).attr("width",n).attr("height",i+o).append("g").attr("class",c._createCssClass("grid-label-rows")).attr("transform","translate("+g.left+","+g.top+")");r.append("g").attr("class","y "+c._createCssClass("axis")).call(m),r.select(".y."+c._createCssClass("axis")).selectAll("text").attr("class",c._getWidgetBaseClass()).text(function(a){return d[a]||a}).style("text-anchor","end").attr("x",n-c.yAxisBuffer).on("click",function(a){c._trigger("rowLabelClicked",void 0,a)}).on("mouseover",function(){d3.select(this).style("fill","rgb(50,50,220)")}).on("mouseout",function(){d3.select(this).style("fill","black")}),q.select(".x."+c._createCssClass("axis")).selectAll("text").attr("class",c._getWidgetBaseClass()).text(function(a){return e[a]||a}).on("click",function(a){c._trigger("columnLabelClicked",void 0,a)}).on("mouseover",function(){d3.select(this).style("fill","rgb(50,50,220)")}).on("mouseout",function(){d3.select(this).style("fill","black")}),p.select(".x."+c._createCssClass("axis")).selectAll("text").attr("transform","translate(-14,10)rotate(-90)"),p.select(".x."+c._createCssClass("axis")).selectAll("text").attr("class",c._getWidgetBaseClass()).style("text-anchor","end").text(function(a){return e[a]||a}),b=c._createCells(q),c._renderCells(q,b),c._createLegend(),c._hasHistogram()&&c._drawHistogram(c.options.histogramMapping),a().qtip&&c._createToolTip("."+c._createCssClass("cell")),c.options.exportOptions&&c.options.exportOptions.style&&(_.isUndefined(window.saveAs)||(a(c._getExportSelector()).append('<a class="'+c._createCssClass("exportButtons")+'">[Export SVG]</a>'),a(c._getExportSelector().children[0]).on("click",function(){c._exportGridVar({filename:Math.random().toString(36).substring(7)+".svg",renderSVG:!0,renderPNG:!1})})),c.options.exportOptions.server&&(a(c._getExportSelector()).append('<a class="'+c._createCssClass("exportButtons")+'">[Export PNG]</a>'),a(c._getExportSelector().children[1]).on("click",function(){"[Export PNG]"===a(this).html()&&(a(this).html("Rendering..."),c._exportGridVar({filename:Math.random().toString(36).substring(7)+".svg",renderSVG:!1,renderPNG:!0}))})))},_hasHistogram:function(){var a=this;return _.has(a.options,"histogramMapping")&&!_.isUndefined(a.options.histogramMapping.data)},_exportGridVar:function(b){var c=this;if(!_.isUndefined(b)&&!_.isUndefined(c.options.exportOptions)){var d,e,f=new XMLSerializer,g=new FormData,h=window.saveAs||window.navigator.msSaveOrOpenBlob,i='<?xml version="1.0" standalone="no"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n<svg xmlns="http://www.w3.org/2000/svg" version="1.1" ',j=f.serializeToString(a(c._getLegendSelector().children[0]).children()[0]),k=f.serializeToString(a(c._getHistogramSelector().children[0]).children()[0]),l=f.serializeToString(a(c._getGridLabelsSelector().children[0]).children()[0]),m=f.serializeToString(a(c._getHeatmapSelector().children[0]).children()[0]),n=10,o=Math.ceil(a(c._getHistogramSelector().children[0]).children()[0].getBBox().width),p=Math.ceil(a(c._getHistogramSelector().children[0]).children()[0].getBBox().height),q=Math.ceil(a(c._getGridLabelsSelector().children[0]).children()[0].getBBox().width),r=Math.ceil(a(c._getHeatmapSelector().children[0]).children()[0].getBBox().width),s=Math.ceil(a(c._getLegendSelector().children[0]).children()[0].getBBox().height),t=Math.ceil(a(c._getLegendSelector().children[0]).children()[0].getBBox().width),u=s+p+n,v=o+q+n+(r>t?r:t+n);a.ajax({type:"GET",url:c.options.exportOptions.style,error:function(b,d,e){throw a(c._getExportSelector().children[1]).html("[Export PNG]"),"Error in obtaining the export styling: "+e},success:function(f){i+='width="'+v+'px" height="'+u+'px">\n',d=i+'<defs><style type="text/css">\n'+f+'</style></defs>\n<g transform="translate(3,0)">'+j+'</g><g transform="translate(0,'+s+')">'+k+'</g><g transform="translate('+o+","+s+')">'+l+'</g><g transform="translate('+(o+q+n)+","+s+')">'+m+"</g></svg>",e=new Blob([d],{type:"image/svg+xml"}),b.renderSVG&&h(e,b.filename),b.renderPNG&&(g.append("data",e),g.append("filename",b.filename),a.ajax({type:"POST",url:c.options.exportOptions.server,data:g,processData:!1,contentType:!1,error:function(b,d,e){throw a(c._getExportSelector().children[1]).html("[Export PNG]"),"Error is rasterizing the PNG: "+e},success:function(b){document.location.href=b,a(c._getExportSelector().children[1]).html("[Export PNG]")}}))}})}}})}(jQuery);